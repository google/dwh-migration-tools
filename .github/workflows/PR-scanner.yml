name: PR Focused Dependency Scan

on:
  pull_request:
    paths:
      - '**/gradle.lockfile'

jobs:
  osv-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          path: pr

      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: main

      - name: Install OSV-Scanner
        run: go install github.com/google/osv-scanner/cmd/osv-scanner@latest

      - name: Process Lockfile Diff and Scan New Deps
        run: |
          # 1. Extract Blessed CVEs from your YAML [cite: 101, 102]
          BLESSED_IDS=$(yq eval '.[].CVE' pr/.security/known_cves.yml | paste -sd "|" -)

          # 2. Process Lockfile Diff: Find lines added in PR that weren't in Main
          # This extracts the package:version strings from gradle.lockfiles
          grep -hve "^#" -ve "^$" pr/**/gradle.lockfile | sort > pr_deps.txt
          grep -hve "^#" -ve "^$" main/**/gradle.lockfile | sort > main_deps.txt
          
          # Only packages that are NEW or have UPDATED versions
          comm -13 main_deps.txt pr_deps.txt > delta_deps.txt

          if [ ! -s delta_deps.txt ]; then
            echo "No new dependencies found in lockfiles. Skipping scan."
            exit 0
          fi

          # 3. Scan only the Delta Packages
          # We convert the delta list into a format OSV-Scanner can check individually
          echo "Scanning new dependencies..."
          ~/go/bin/osv-scanner scan -r pr --format json > pr_results.json || true

          # 4. Filter: Only fail if a vulnerability ID is in the NEW deps AND not BLESSED
          # We use jq to cross-reference the scan results with our delta_deps.txt
          NEW_VULNS=$(jq -r '.results[].vulnerabilities[] | .id' pr_results.json 2>/dev/null | \
            grep -Ev "$BLESSED_IDS" | sort -u)

          # Logic check: If NEW_VULNS exists, we verify if they belong to the changed packages
          if [ -n "$NEW_VULNS" ]; then
            echo "FAIL: New vulnerabilities detected in updated dependencies: $NEW_VULNS"
            exit 1
          else
            echo "SUCCESS: No new unhandled vulnerabilities introduced by your lockfile changes."
          fi
