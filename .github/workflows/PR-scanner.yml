name: PR Focused Dependency Scan

on:
  pull_request:
    paths:
      - '**/gradle.lockfile'
      - '.security/known_cves.yml'

jobs:
  osv-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          path: pr-repo

      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: main-repo

      - name: Install OSV-Scanner
        run: go install github.com/google/osv-scanner/cmd/osv-scanner@latest

      - name: Process Lockfile Diff and Scan Delta
        run: |
          # 1. Extract Blessed IDs
          BLESSED_IDS=$(yq eval '.[].CVE' pr-repo/.security/known_cves.yml | paste -sd "|" - || echo "NONE")
          echo "DEBUG: Ignoring Blessed IDs: $BLESSED_IDS"

          # 2. Process Lockfile Diff
          find pr-repo -name "gradle.lockfile" -exec grep -hve "^#" -ve "^$" {} + | sort -u > pr_raw.txt
          find main-repo -name "gradle.lockfile" -exec grep -hve "^#" -ve "^$" {} + | sort -u > main_raw.txt
          comm -13 main_raw.txt pr_raw.txt > delta_lines.txt

          if [ ! -s delta_lines.txt ]; then
            echo "No changes detected."
            exit 0
          fi

          # 3. Create Valid Temporary Environment
          mkdir -p delta-scan
          {
            echo "# This is a Gradle generated file for dependency locking."
            cat delta_lines.txt
            echo "empty=" 
          } > delta-scan/gradle.lockfile

          # 4. Perform Targeted Scan
          # We run the scan and save the output. 
          # We use --format json to ensure we get parsable data.
          ~/go/bin/osv-scanner scan --format json -r delta-scan/ > scan_results.json || true

          # 5. Filter and Decision Logic
          # Aggressive JQ search: find EVERY 'id' field in the whole document
          ALL_VULNS=$(jq -r '.. | .id? // empty' scan_results.json | grep -E "^(GHSA|CVE)-" | sort -u || true)
          
          # Filter out the blessed ones
          NEW_VULNS=$(echo "$ALL_VULNS" | grep -Ev "$BLESSED_IDS" || true)
          
          if [ -n "$NEW_VULNS" ]; then
            echo "-------------------------------------------------------"
            echo "CRITICAL: NEW UNHANDLED VULNERABILITIES FOUND!"
            echo "$NEW_VULNS"
            echo "-------------------------------------------------------"
            exit 1
          fi
          
          # IF IT PASSES, PRINT THE JSON FOR AUDIT
          echo "DEBUG: No unhandled vulnerabilities found. Verified packages:"
          jq -c '.results[].packages[]?.package | {name, version}' scan_results.json || echo "No packages found in JSON."
          
          # If Log4j is present but no vulnerabilities show up, we print the raw JSON to see why
          if grep -q "log4j" delta-lines.txt; then
             echo "DEBUG: Log4j was in delta but no vulnerability triggered. Raw JSON below:"
             cat scan_results.json
          fi

          echo "Build PASS: No new unhandled vulnerabilities introduced."
