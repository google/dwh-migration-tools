name: PR Focused Dependency Scan

on:
  pull_request:
    paths:
      - '**/gradle.lockfile'

jobs:
  osv-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          path: pr-repo

      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: main-repo

      - name: Install OSV-Scanner
        run: go install github.com/google/osv-scanner/cmd/osv-scanner@latest

     - name: Process Lockfile Diff and Scan
        run: |
          # 1. Extract Blessed CVE IDs
          BLESSED_IDS=$(yq eval '.[].CVE' pr-repo/.security/known_cves.yml | paste -sd "|" - || echo "NONE")
          echo "DEBUG: Blessed IDs being ignored: $BLESSED_IDS"

          # 2. Process Lockfile Diff
          find pr-repo -name "gradle.lockfile" -exec grep -hve "^#" -ve "^$" {} + | sed 's/=.*//' | sort -u > pr_deps.txt
          find main-repo -name "gradle.lockfile" -exec grep -hve "^#" -ve "^$" {} + | sed 's/=.*//' | sort -u > main_deps.txt
          comm -13 main_deps.txt pr_deps.txt > delta_deps.txt

          echo "DEBUG: Detected Delta Dependencies (PR vs Main):"
          cat delta_deps.txt

          if [ ! -s delta_deps.txt ]; then
            echo "No new dependency versions found. Skipping further checks."
            exit 0
          fi

          # 3. Google OSV Scan
          ~/go/bin/osv-scanner scan --format json -r pr-repo > pr_results.json || true
          
          # Debug: Show how many vulnerabilities were found in total before filtering
          TOTAL_FOUND=$(jq '.results[].vulnerabilities | length' pr_results.json | awk '{s+=$1} END {print s}')
          echo "DEBUG: Total vulnerabilities found by OSV-Scanner (unfiltered): $TOTAL_FOUND"

          # 4. Robust Filter Logic with Debugging
          NEW_UNHANDLED_VULNS=""
          while read -r dep; do
            pkg_name=$(echo "$dep" | cut -d':' -f1,2)
            echo "DEBUG: Checking for vulnerabilities in changed package: $pkg_name"
            
            # This captures the raw match from OSV to see if naming convention is the issue
            RAW_MATCH=$(jq -c --arg PKG "$pkg_name" '
              .results[].vulnerabilities[]? | 
              select(.package.name | contains($PKG))' pr_results.json || echo "")
            
            if [ -n "$RAW_MATCH" ]; then
              echo "DEBUG: Match found for $pkg_name: $RAW_MATCH"
              
              # Now filter out the Blessed IDs
              found=$(echo "$RAW_MATCH" | jq -r '.id' | grep -Ev "$BLESSED_IDS" || true)
              
              if [ -n "$found" ]; then
                echo "DEBUG: Vulnerability $found is NOT blessed. Failing build."
                NEW_UNHANDLED_VULNS="$NEW_UNHANDLED_VULNS $found"
              else
                echo "DEBUG: Vulnerability in $pkg_name is already in known_cves.yml. Skipping."
              fi
            else
              echo "DEBUG: No vulnerability found in OSV results for $pkg_name."
            fi
          done < delta_deps.txt

          if [ -n "$NEW_UNHANDLED_VULNS" ]; then
            echo "Build FAIL: New vulnerabilities detected in changed dependencies: $NEW_UNHANDLED_VULNS"
            exit 1
          else
            echo "Build PASS: No new unhandled vulnerabilities introduced."
          fi
