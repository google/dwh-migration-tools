name: PR Dependency Scan

on:
  pull_request:
    paths:
      - '**/gradle.lockfile'

jobs:
  osv-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          path: pr

      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: main

      - name: Install OSV-Scanner
        run: go install github.com/google/osv-scanner/cmd/osv-scanner@latest

      - name: Compare and Scan
        run: |
          # 1. Scan Main to see what's already there
          ~/go/bin/osv-scanner scan -r main --format json > main_results.json || true
          
          # 2. Scan PR to see the current state
          ~/go/bin/osv-scanner scan -r pr --format json > pr_results.json || true

          # 3. Logic to check if NEW vulnerabilities were added
          # If the number of vulnerabilities in PR is greater than Main, FAIL the build.
          PR_COUNT=$(jq '.results[].vulnerabilities | length' pr_results.json | awk '{s+=$1} END {print s}')
          MAIN_COUNT=$(jq '.results[].vulnerabilities | length' main_results.json | awk '{s+=$1} END {print s}')
          
          if [ "$PR_COUNT" -gt "$MAIN_COUNT" ]; then
            echo "New vulnerabilities detected! PR Count: $PR_COUNT, Main Count: $MAIN_COUNT"
            exit 1
          else
            echo "No new vulnerabilities introduced by this PR."
          fi
