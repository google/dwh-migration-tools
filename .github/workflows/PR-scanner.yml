- name: Process Lockfile Diff and Scan Delta
        run: |
          # 1. Extract Blessed CVE IDs
          BLESSED_IDS=$(yq eval '.[].CVE' pr-repo/.security/known_cves.yml | paste -sd "|" - || echo "NONE")

          # 2. Identify the Delta (changed group:artifact:version)
          find pr-repo -name "gradle.lockfile" -exec grep -hve "^#" -ve "^$" {} + | sed 's/=.*//' | sort -u > pr_deps.txt
          find main-repo -name "gradle.lockfile" -exec grep -hve "^#" -ve "^$" {} + | sed 's/=.*//' | sort -u > main_deps.txt
          comm -13 main_deps.txt pr_deps.txt > delta_deps.txt

          if [ ! -s delta_deps.txt ]; then
            echo "No new dependency versions found."
            exit 0
          fi

          echo "DEBUG: Scanning the following delta packages:"
          cat delta_deps.txt

          # 3. Targeted Scan
          # Instead of scanning the whole dir, we loop through the delta and scan each package
          NEW_UNHANDLED_VULNS=""
          while read -r dep; do
            # Split group:artifact:version
            GROUP=$(echo "$dep" | cut -d':' -f1)
            ARTIFACT=$(echo "$dep" | cut -d':' -f2)
            VERSION=$(echo "$dep" | cut -d':' -f3)

            echo "Scanning $GROUP:$ARTIFACT version $VERSION..."
            
            # Use osv-scanner to check the specific Maven artifact
            # We filter out IDs already in your blessed list
            found=$(~/go/bin/osv-scanner scan --format json --package "pkg:maven/$GROUP/$ARTIFACT@$VERSION" | \
              jq -r '.results[].vulnerabilities[]?.id' | grep -Ev "$BLESSED_IDS" | sort -u || true)
            
            if [ -n "$found" ]; then
              echo "DEBUG: Found NEW unhandled vulnerability for $ARTIFACT: $found"
              NEW_UNHANDLED_VULNS="$NEW_UNHANDLED_VULNS $found"
            fi
          done < delta_deps.txt

          # 4. Final Decision
          if [ -n "$NEW_UNHANDLED_VULNS" ]; then
            echo "Build FAIL: New vulnerabilities detected in your changes: $NEW_UNHANDLED_VULNS"
            exit 1
          else
            echo "Build PASS: No new unhandled vulnerabilities introduced."
          fi
