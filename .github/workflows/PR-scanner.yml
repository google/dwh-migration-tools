name: PR Dependency Scan (Delta Only)

on:
  pull_request:
    paths:
      - '**/gradle.lockfile'
      - '.security/known_cves.yml'

jobs:
  osv-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          path: pr-branch

      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: main-branch

      - name: Install OSV-Scanner and jq
        run: |
          go install github.com/google/osv-scanner/cmd/osv-scanner@latest
          sudo apt-get install jq -y

      - name: Generate Suppression Config
        run: |
          # Create a TOML config from your YAML known_cves.yml
          echo "[config]" > osv-scanner.toml
          yq eval '.[].CVE' pr-branch/.security/known_cves.yml | while read -r cve; do
            if [ "$cve" != "null" ]; then
              echo "[[ignored_vulnerabilities]]" >> osv-scanner.toml
              echo "id = \"$cve\"" >> osv-scanner.toml
            fi
          done

      - name: Compare PR vs Main (Excluding Suppressions)
        run: |
          # 1. Scan Main branch (with suppressions)
          ~/go/bin/osv-scanner scan -r main-branch --config=osv-scanner.toml --format json > main_results.json || true
          
          # 2. Scan PR branch (with suppressions)
          ~/go/bin/osv-scanner scan -r pr-branch --config=osv-scanner.toml --format json > pr_results.json || true

          # 3. Extract IDs of vulnerabilities that are NOT suppressed
          MAIN_IDS=$(jq -r '.results[].vulnerabilities[].id' main_results.json 2>/dev/null | sort -u)
          PR_IDS=$(jq -r '.results[].vulnerabilities[].id' pr_results.json 2>/dev/null | sort -u)

          # 4. Find vulnerabilities in PR that do NOT exist in Main
          NEW_VULNS=$(comm -13 <(echo "$MAIN_IDS") <(echo "$PR_IDS"))

          if [ -n "$NEW_VULNS" ]; then
            echo "FAIL: The following NEW vulnerabilities were introduced by this PR:"
            echo "$NEW_VULNS"
            exit 1
          else
            echo "SUCCESS: No new vulnerabilities introduced (Zero-Day vulnerabilities in Main are ignored)."
          fi
