name: PR Focused Dependency Scan

on:
  pull_request:
    paths:
      - '**/gradle.lockfile'
      - '.security/known_cves.yml'

jobs:
  osv-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          path: pr-repo

      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: main-repo

      - name: Install OSV-Scanner
        run: go install github.com/google/osv-scanner/cmd/osv-scanner@latest

      - name: Process Lockfile Diff and Scan Delta
        run: |
          # 1. Extract Blessed CVE IDs from known_cves.yml
          BLESSED_IDS=$(yq eval '.[].CVE' pr-repo/.security/known_cves.yml | paste -sd "|" - || echo "NONE")
          echo "DEBUG: Blessed IDs being ignored: $BLESSED_IDS"

          # 2. Process Lockfile Diff to find the "Delta"
          # We clean the group:artifact:version for comparison
          find pr-repo -name "gradle.lockfile" -exec grep -hve "^#" -ve "^$" {} + | sed 's/=.*//' | sort -u > pr_deps.txt
          find main-repo -name "gradle.lockfile" -exec grep -hve "^#" -ve "^$" {} + | sed 's/=.*//' | sort -u > main_deps.txt
          comm -13 main_deps.txt pr_deps.txt > delta_deps.txt

          if [ ! -s delta_deps.txt ]; then
            echo "No new dependency versions found. Skipping scan."
            exit 0
          fi

          echo "DEBUG: Changes detected in: $(cat delta_deps.txt)"

          # 3. Create a temporary 'delta' lockfile for OSV-Scanner
          # This forces the scanner to only look at the changed packages
          echo "# PURE DELTA LOCKFILE" > delta.lockfile
          cat delta_deps.txt >> delta.lockfile

          # 4. Scan the delta lockfile using the standard 'scan' command
          # This avoids the undefined --package flag while remaining targeted
          SCAN_OUT=$(~/go/bin/osv-scanner scan --format json --lockfile=delta.lockfile || true)

          # 5. Extract and Filter Vulnerabilities
          if echo "$SCAN_OUT" | jq -e . >/dev/null 2>&1; then
            NEW_UNHANDLED_VULNS=$(echo "$SCAN_OUT" | jq -r '.results[].vulnerabilities[]?.id' | grep -Ev "$BLESSED_IDS" | sort -u || true)
            
            if [ -n "$NEW_UNHANDLED_VULNS" ]; then
              echo "Build FAIL: New vulnerabilities detected in changed dependencies: $NEW_UNHANDLED_VULNS"
              exit 1
            else
              echo "Build PASS: No new unhandled vulnerabilities introduced."
            fi
          else
            echo "DEBUG: No vulnerabilities found in the delta packages."
            echo "Build PASS: No new unhandled vulnerabilities introduced."
          fi
